<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>管理员后台 - LSPD</title>
  <link rel="icon" href="assets/img/LSPD_LOGO.png" />
  <style>
    :root{--brand:#0f1c6f;--muted:#64748b}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:0;background:#f5f7fb;color:#0f172a}
    .nav{display:flex;align-items:center;gap:16px;padding:12px 16px;background:#fff;border-bottom:1px solid #e5e7eb;position:sticky;top:0}
    .nav .brand{display:flex;align-items:center;gap:10px}
    .nav img{width:32px;height:32px;object-fit:contain}
    .links{margin-left:auto;display:flex;gap:12px}
    .links a{color:#334155;text-decoration:none;padding:6px 8px;border-radius:8px}
    .links a:hover{background:#f1f5f9}
    .container{max-width:1040px;margin:28px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 4px 12px rgba(15,23,42,.04)}
    .hd{padding:18px 20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
    .bd{padding:20px}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid #eef2f7;text-align:left;font-size:14px}
    th{font-weight:700;color:#334155}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#eef2ff;font-size:12px}
    .btn{display:inline-block;padding:9px 14px;border-radius:10px;border:1px solid #e2e8f0;background:#fff;cursor:pointer;text-decoration:none;color:#0f172a}
    .btnPrimary{background:var(--brand);color:#fff;border-color:transparent}
    #adminOnly{display:none}
    #err{color:#b91c1c;margin-top:8px;display:none}
  </style>
</head>
<body>
  <nav class="nav">
    <div class="brand">
      <img src="assets/img/LSPD LOGO.png" alt="Sheriff star">
      <span class="muted">洛圣都市警察局 · 管理员后台</span>
    </div>
    <div class="links">
      <a href="index.html">首页</a>
      <a href="roster.html">警员名册</a>
      <a href="profile.html">个人资料</a>
      <a href="javascript:void(0)" id="logoutBtn" class="btn">退出登录</a>
    </div>
  </nav>

  <main class="container">
    <div class="card">
      <div class="hd">
        <div>
          <span class="pill">管理员面板</span>
        </div>
        <div id="who" class="muted"></div>
      </div>
      <div class="bd">
        <div id="err"></div>
        <div id="adminOnly">
          <p class="muted" style="margin-top:0">只有 <strong>roles/{email}.admin = true</strong> 的账户可见。</p>
          <table>
            <thead>
              <tr>
                <th>姓名</th>
                <th>警号</th>
                <th>呼号</th>
                <th>部门</th>
                <th>状态</th>
                <th>邮箱</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td colspan="6" class="muted">加载中…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { requireLogin, doLogout, db } from "./assets/js/auth.js";
    import { doc, getDoc, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    const tbody = document.getElementById("tbody");
    const err = document.getElementById("err");
    const who = document.getElementById("who");
    const adminOnly = document.getElementById("adminOnly");

    function showError(msg){
      err.textContent = msg;
      err.style.display = "block";
    }

    requireLogin(async (user) => {
      document.getElementById("logoutBtn").onclick = () => doLogout();
      who.textContent = user.email;

      // 检查管理员
      const emailLower = (user.email||"").toLowerCase();
      const roleRef = doc(db, "roles", emailLower);
      const roleSnap = await getDoc(roleRef);
      const isAdmin = roleSnap.exists() && roleSnap.data().admin === true;
      if(!isAdmin){
        showError("你不是管理员，无法访问该页面。");
        tbody.innerHTML = '<tr><td colspan="6" class="muted">没有权限</td></tr>';
        return;
      }

      adminOnly.style.display = "block";

      // 读取所有 user 文档并渲染
      try{
        const q = query(collection(db, "user"), orderBy("name"));
        const qs = await getDocs(q);
        if(qs.empty){
          tbody.innerHTML = '<tr><td colspan="6" class="muted">暂无用户。</td></tr>';
          return;
        }
        tbody.innerHTML = "";
        qs.forEach((d)=>{
          const data = d.data() || {};
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${data.name || ""}</td>
            <td>${data.badge || ""}</td>
            <td>${data.callsign || ""}</td>
            <td>${data.division || ""}</td>
            <td>${data.status || ""}</td>
            <td>${d.id}</td>
          `;
          tbody.appendChild(tr);
        });
      }catch(e){
        console.error(e);
        showError("加载用户列表失败：权限或规则不允许，或字段缺失。");
      }
    });
  </script>
</body>
</html>
