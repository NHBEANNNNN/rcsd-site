<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>赃物管理 - LSPD</title>
    <link rel="stylesheet" href="assets/css/styles.css" />
  </head>
  <body>
    <nav class="nav" aria-label="主导航">
      <div class="bar">
        <div class="brand">
          <img src="assets/img/LSPD LOGO.png" alt="LSPD logo" />
          <span class="title">洛圣都城市警察局</span>
        </div>
        <div class="links">
          <a href="index.html">首页</a>
          <a href="contraband.html" id="contrabandLink" style="display:none">赃物上报</a>
          <a href="contraband-admin.html" id="contrabandAdminLink" style="display:none">赃物管理</a>
          <a href="profile.html">个人资料</a>
          <a href="login.html" id="loginLink">登录</a>
          <a href="javascript:void(0)" id="logoutBtn" style="display:none">退出登录</a>
        </div>
      </div>
    </nav>

    <main class="container">
      <h1>赃物管理</h1>
      <p class="muted">此页面列出所有上报的赃物，仅管理员可见。</p>

      <div id="statsKpis" class="kpis"></div>

      <div id="err" style="color:var(--danger);display:none;margin-top:8px;"></div>
      <div id="loading" class="muted" style="margin-top:8px;">加载中...</div>

      <table id="goodsTable" style="display:none;margin-top:12px;">
        <thead>
          <tr>
            <th>物品名称</th>
            <th>数量</th>
            <th>描述</th>
            <th>上报人</th>
            <th>状态</th>
            <th>上报时间</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="goodsBody"></tbody>
      </table>
    </main>

    <script type="module">
      import { auth, db, requireLogin, doLogout } from './assets/js/auth.js';
      import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js';
      import {
        doc, getDoc, getDocs, collection, query, orderBy, updateDoc, deleteDoc
      } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js';

      const loginLink = document.getElementById('loginLink');
      const logoutBtn = document.getElementById('logoutBtn');
      const contrabandLink = document.getElementById('contrabandLink');
      const contrabandAdminLink = document.getElementById('contrabandAdminLink');

      window.addEventListener('error', (e) => {
        const err = document.getElementById('err');
        if (err) {
          err.style.display = 'block';
          err.textContent = '脚本错误：' + (e?.message || 'unknown');
          const loading = document.getElementById('loading');
          if (loading) loading.style.display = 'none';
        }
      });

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          if (loginLink) loginLink.style.display = 'none';
          if (logoutBtn) logoutBtn.style.display = 'inline';
          if (contrabandLink) contrabandLink.style.display = 'inline';
          try {
            const emailLower = (user.email || '').toLowerCase();
            const roleSnap = await getDoc(doc(db, 'roles', emailLower));
            const isAdmin = roleSnap.exists() && roleSnap.data().admin === true;
            if (isAdmin && contrabandAdminLink) contrabandAdminLink.style.display = 'inline';
          } catch (_) {}
        } else {
          if (loginLink) loginLink.style.display = 'inline';
          if (logoutBtn) logoutBtn.style.display = 'none';
          if (contrabandLink) contrabandLink.style.display = 'none';
          if (contrabandAdminLink) contrabandAdminLink.style.display = 'none';
        }
      });

      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => { await doLogout(); });
      }

      requireLogin(async (user) => {
        const emailLower = (user.email || '').toLowerCase();
        const roleSnap = await getDoc(doc(db, 'roles', emailLower));
        const isAdmin = roleSnap.exists() && roleSnap.data().admin === true;
        if (!isAdmin) {
          document.getElementById('loading').style.display = 'none';
          const err = document.getElementById('err');
          err.textContent = '您不是管理员，无法访问此页面。';
          err.style.display = 'block';
          return;
        }

        let processedCount = 0, pendingCount = 0, totalQuantity = 0;
        const categoryCounts = {}; // { itemName: { processed: n, pending: m } }

        const goodsBody = document.getElementById('goodsBody');
        try {
          const q = query(collection(db, 'contraband'), orderBy('createdAt', 'desc'));
          const snapshot = await getDocs(q);
          goodsBody.innerHTML = '';

          snapshot.forEach((docSnap) => {
            const data = docSnap.data() || {};
            const itemName = data.itemName || '未知';
            const qty = parseInt(data.quantity, 10) || 0;
            const status = (data.status || '').toLowerCase();
            const isProcessed = status.startsWith('proc'); // 以 proc 开头视为已处理

            // KPI 统计（条目数量）
            if (isProcessed) processedCount += 1; else pendingCount += 1;
            totalQuantity += qty;

            // 类别统计（数量维度）
            if (!categoryCounts[itemName]) categoryCounts[itemName] = { processed: 0, pending: 0 };
            if (isProcessed) categoryCounts[itemName].processed += qty;
            else categoryCounts[itemName].pending += qty;

            // 表格行
            const tr = document.createElement('tr');
            tr.innerHTML = \`
              <td>\${itemName}</td>
              <td style="text-align:center">\${qty}</td>
              <td>\${(data.description || '').substring(0, 100)}</td>
              <td>\${data.user || ''}</td>
              <td>\${data.status || ''}</td>
              <td>\${data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString() : ''}</td>
              <td style="white-space:nowrap">
                <button class="btn btn-outline edit-btn" data-id="\${docSnap.id}" style="margin-right:6px;">编辑</button>
                <button class="btn btn-primary delete-btn" data-id="\${docSnap.id}">删除</button>
              </td>
            \`;
            goodsBody.appendChild(tr);
          });

          // 绑定编辑按钮
          document.querySelectorAll('.edit-btn').forEach((btn) => {
            btn.addEventListener('click', async (e) => {
              const id = e.currentTarget.getAttribute('data-id');
              const ref = doc(db, 'contraband', id);
              try {
                const snap = await getDoc(ref);
                if (!snap.exists()) return;
                const data = snap.data();
                const newName = window.prompt('修改物品名称', data.itemName ?? '');
                const newQtyStr = window.prompt('修改数量', data.quantity ?? '');
                const newDesc = window.prompt('修改描述', data.description ?? '');
                const newStatus = window.prompt('修改状态(processed/pending等)', data.status ?? 'pending');

                const updates = {};
                if (newName !== null && newName.trim() !== '' && newName !== data.itemName) updates.itemName = newName.trim();
                if (newQtyStr !== null) {
                  const qv = parseInt(newQtyStr, 10);
                  if (!Number.isNaN(qv) && qv >= 0 && qv !== data.quantity) updates.quantity = qv;
                }
                if (newDesc !== null && newDesc !== data.description) updates.description = newDesc;
                if (newStatus !== null && newStatus !== data.status) updates.status = newStatus;

                if (Object.keys(updates).length > 0) {
                  await updateDoc(ref, updates);
                  alert('更新成功');
                  window.location.reload();
                }
              } catch (err) {
                console.error('更新失败', err);
                alert('更新失败：' + (err?.message || err));
              }
            });
          });

          // 绑定删除按钮
          document.querySelectorAll('.delete-btn').forEach((btn) => {
            btn.addEventListener('click', async (e) => {
              const id = e.currentTarget.getAttribute('data-id');
              if (!window.confirm('确定删除该记录吗？')) return;
              try {
                await deleteDoc(doc(db, 'contraband', id));
                alert('删除成功');
                window.location.reload();
              } catch (err) {
                console.error('删除失败', err);
                alert('删除失败：' + (err?.message || err));
              }
            });
          });

          // 渲染 KPI + 分类统计
          const statsEl = document.getElementById('statsKpis');
          statsEl.innerHTML = \`
            <div class="card hoverable">
              <div class="meta"><span class="badge">已处理</span></div>
              <h3 style="font-size:28px;margin:6px 0;">\${processedCount}</h3>
              <p class="muted">条目数</p>
            </div>
            <div class="card hoverable">
              <div class="meta"><span class="badge" style="background:var(--warn)">未处理</span></div>
              <h3 style="font-size:28px;margin:6px 0;">\${pendingCount}</h3>
              <p class="muted">条目数</p>
            </div>
            <div class="card hoverable">
              <div class="meta"><span class="badge" style="background:linear-gradient(135deg,var(--accent-2),var(--accent))">总数量</span></div>
              <h3 style="font-size:28px;margin:6px 0;">\${totalQuantity}</h3>
              <p class="muted">件（按数量汇总）</p>
            </div>
            <div class="card" style="grid-column:1/-1">
              <h3 style="margin-bottom:8px;">各物品类别总数</h3>
              <ul class="list">
                \${Object.entries(categoryCounts).map(([item, val]) => {
                  const p = val.processed || 0;
                  const d = val.pending || 0;
                  return \`<li>\${item}：已处理 \${p} / 未处理 \${d}</li>\`;
                }).join('')}
              </ul>
            </div>
          \`;

          document.getElementById('loading').style.display = 'none';
          document.getElementById('goodsTable').style.display = 'table';
        } catch (err) {
          console.error(err);
          const errDiv = document.getElementById('err');
          errDiv.textContent = '加载赃物列表失败：' + (err?.message || err);
          errDiv.style.display = 'block';
          document.getElementById('loading').style.display = 'none';
        }
      });
    </script>
  </body>
</html>
