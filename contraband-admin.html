<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>赃物管理 - LSPD</title>
  <link rel="stylesheet" href="assets/css/styles.css" />
  <style>
    .num { font-size:28px; font-weight:800; }
    .right { text-align:right }
  </style>
</head>
<body>
  <!-- 顶部导航（与站点统一） -->
  <nav class="nav" aria-label="主导航">
    <div class="bar">
      <div class="brand">
        <img src="assets/img/LSPD LOGO.png" alt="LSPD logo" />
        <span class="title">洛圣都城市警察局</span>
      </div>
      <div class="links">
        <a href="index.html">首页</a>
        <a href="videos.html">视频专区</a>
        <a href="news.html">新闻通告</a>
        <a href="services.html">便民服务</a>
        <a href="divisions.html">部门</a>
        <a href="jail.html">拘留所</a>
        <a href="careers.html">招募</a>
        <a href="contact.html">联系</a>
        <a href="roster.html">警员名册</a>
        <a href="informants.html" id="informantsLink" style="display:none">线人信息</a>
        <a href="contraband.html" id="contrabandLink" style="display:none">赃物上报</a>
        <a href="contraband-admin.html" id="contrabandAdminLink" style="display:none">赃物管理</a>
        <a href="profile.html">个人资料</a>
        <a href="login.html" id="loginLink">登录</a>
        <a href="javascript:void(0)" id="logoutBtn" style="display:none">退出登录</a>
      </div>
    </div>
  </nav>

  <main class="container">
    <h1>赃物管理</h1>
    <p class="muted">此页面列出所有上报的赃物，仅管理员可见。</p>

    <!-- 早期错误面板（避免静默卡住） -->
    <div id="err" class="notice" style="display:none"></div>
    <div id="loading" class="muted">加载中...</div>

    <!-- KPI 区 -->
    <div id="statsKpis" class="kpis" style="margin-top:8px"></div>

    <!-- 表格 -->
    <table id="goodsTable" style="display:none;margin-top:12px">
      <thead>
        <tr>
          <th>物品名称</th>
          <th>数量</th>
          <th>描述</th>
          <th>上报人</th>
          <th>状态</th>
          <th>上报时间</th>
          <th class="right">操作</th>
        </tr>
      </thead>
      <tbody id="goodsBody"></tbody>
    </table>
  </main>

  <!-- 先注入一个非模块脚本：提供错误显示能力 -->
  <script>
    (function(){
      window.__showErr = function(msg){
        try{
          const e = document.getElementById('err');
          const l = document.getElementById('loading');
          if(e){ e.style.display='block'; e.textContent = '错误：' + msg; }
          if(l){ l.style.display='none'; }
        }catch(_){}
      };
      window.addEventListener('error', function(ev){
        window.__showErr(ev && ev.message ? ev.message : '未知错误');
      });
    })();
  </script>

  <!-- 主逻辑改为动态 import，任何一步失败都会显示错误而不是卡住 -->
  <script type="module">
  (async () => {
    try {
      // 1) 动态加载本地 auth.js（避免静态 import 失败时整段脚本不执行）
      const { auth, db, requireLogin, doLogout } = await import('./assets/js/auth.js');

      // 2) 动态加载 Firebase 模块
      const { onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js');
      const {
        doc, getDoc, getDocs, collection, query, orderBy, updateDoc, deleteDoc
      } = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js');

      // ——— 导航显隐 ———
      const loginLink = document.getElementById('loginLink');
      const logoutBtn = document.getElementById('logoutBtn');
      const informantsLink = document.getElementById('informantsLink');
      const contrabandLink = document.getElementById('contrabandLink');
      const contrabandAdminLink = document.getElementById('contrabandAdminLink');

      onAuthStateChanged(auth, async (user) => {
        try{
          if (user) {
            if (loginLink) loginLink.style.display = 'none';
            if (logoutBtn) logoutBtn.style.display = 'inline';
            if (informantsLink) informantsLink.style.display = 'inline';
            if (contrabandLink) contrabandLink.style.display = 'inline';
            const emailLower = (user.email || '').toLowerCase();
            const roleSnap = await getDoc(doc(db, 'roles', emailLower));
            if (roleSnap.exists() && roleSnap.data().admin === true) {
              if (contrabandAdminLink) contrabandAdminLink.style.display = 'inline';
            }
          } else {
            if (loginLink) loginLink.style.display = 'inline';
            if (logoutBtn) logoutBtn.style.display = 'none';
            if (informantsLink) informantsLink.style.display = 'none';
            if (contrabandLink) contrabandLink.style.display = 'none';
            if (contrabandAdminLink) contrabandAdminLink.style.display = 'none';
          }
        }catch(e){ console.error(e) }
      });

      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          try{ await doLogout(); }catch(e){ window.__showErr(e.message || e) }
        });
      }

      // ——— 需要登录 & 管理员身份 ———
      requireLogin(async (user) => {
        try {
          const emailLower = (user.email || '').toLowerCase();
          const roleSnap = await getDoc(doc(db, 'roles', emailLower));
          const isAdmin = roleSnap.exists() && roleSnap.data().admin === true;
          if (!isAdmin) {
            window.__showErr('您不是管理员，无法访问此页面。');
            return;
          }

          // 统计变量
          let processedCount = 0, pendingCount = 0, totalQuantity = 0;
          const categoryCounts = {}; // { name: { processed, pending } }

          const goodsBody = document.getElementById('goodsBody');
          const loading = document.getElementById('loading');
          const table = document.getElementById('goodsTable');

          const qRef = query(collection(db, 'contraband'), orderBy('createdAt', 'desc'));
          const snapshot = await getDocs(qRef);
          goodsBody.innerHTML = '';

          snapshot.forEach((docSnap) => {
            const data = docSnap.data() || {};
            const itemName = data.itemName || '未知';
            const qty = Number.parseInt(data.quantity, 10) || 0;
            const statusText = String(data.status || '').toLowerCase();
            const isProcessed = statusText.startsWith('proc'); // 以 proc 开头视作已处理

            // KPI(条目数) & 数量累加
            if (isProcessed) processedCount += 1; else pendingCount += 1;
            totalQuantity += qty;

            // 分类统计（数量维度）
            if (!categoryCounts[itemName]) categoryCounts[itemName] = { processed: 0, pending: 0 };
            if (isProcessed) categoryCounts[itemName].processed += qty;
            else categoryCounts[itemName].pending += qty;

            // 处理时间字段的鲁棒性
            let createdText = '';
            const ts = data.createdAt;
            try {
              if (ts && typeof ts.toDate === 'function') {
                createdText = ts.toDate().toLocaleString();
              } else if (ts && typeof ts === 'object' && 'seconds' in ts) {
                createdText = new Date(ts.seconds * 1000).toLocaleString();
              } else if (typeof ts === 'number') {
                createdText = new Date(ts).toLocaleString();
              }
            } catch(_) {}

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${itemName}</td>
              <td style="text-align:center">${qty}</td>
              <td>${(data.description || '').substring(0, 100)}</td>
              <td>${data.user || ''}</td>
              <td>${data.status || ''}</td>
              <td>${createdText}</td>
              <td class="right" style="white-space:nowrap">
                <button class="btn btn-outline edit-btn" data-id="${docSnap.id}" style="margin-right:6px">编辑</button>
                <button class="btn btn-primary delete-btn" data-id="${docSnap.id}">删除</button>
              </td>
            `;
            goodsBody.appendChild(tr);
          });

          // 事件：编辑
          document.querySelectorAll('.edit-btn').forEach((btn) => {
            btn.addEventListener('click', async (e) => {
              const id = e.currentTarget.getAttribute('data-id');
              const ref = doc(db, 'contraband', id);
              try {
                const snap = await getDoc(ref);
                if (!snap.exists()) return;
                const d = snap.data();
                const newName = window.prompt('修改物品名称', d.itemName ?? '');
                const newQty = window.prompt('修改数量', d.quantity ?? '');
                const newDesc = window.prompt('修改描述', d.description ?? '');
                const newStatus = window.prompt('修改状态(processed/pending/自定义)', d.status ?? 'pending');

                const patch = {};
                if (newName !== null && newName.trim() !== '' && newName !== d.itemName) patch.itemName = newName.trim();
                if (newQty !== null) {
                  const qv = Number.parseInt(newQty, 10);
                  if (!Number.isNaN(qv) && qv >= 0 && qv !== d.quantity) patch.quantity = qv;
                }
                if (newDesc !== null && newDesc !== d.description) patch.description = newDesc;
                if (newStatus !== null && newStatus !== d.status) patch.status = newStatus;

                if (Object.keys(patch).length > 0) {
                  await updateDoc(ref, patch);
                  alert('更新成功'); location.reload();
                }
              } catch (err) {
                window.__showErr('更新失败：' + (err?.message || err));
              }
            });
          });

          // 事件：删除
          document.querySelectorAll('.delete-btn').forEach((btn) => {
            btn.addEventListener('click', async (e) => {
              const id = e.currentTarget.getAttribute('data-id');
              if (!confirm('确定删除该记录吗？')) return;
              try {
                await deleteDoc(doc(db, 'contraband', id));
                alert('删除成功'); location.reload();
              } catch (err) {
                window.__showErr('删除失败：' + (err?.message || err));
              }
            });
          });

          // 渲染 KPI & 分类统计
          const statsEl = document.getElementById('statsKpis');
          statsEl.innerHTML = `
            <div class="card hoverable">
              <div class="meta"><span class="badge">已处理</span></div>
              <div class="num">${processedCount}</div>
              <p class="muted">条目数</p>
            </div>
            <div class="card hoverable">
              <div class="meta"><span class="badge" style="background:var(--warn)">未处理</span></div>
              <div class="num">${pendingCount}</div>
              <p class="muted">条目数</p>
            </div>
            <div class="card hoverable">
              <div class="meta"><span class="badge" style="background:linear-gradient(135deg,var(--accent-2),var(--accent))">总数量</span></div>
              <div class="num">${totalQuantity}</div>
              <p class="muted">件（按数量汇总）</p>
            </div>
            <div class="card" style="grid-column:1/-1">
              <h3 style="margin-bottom:8px;">各物品类别总数</h3>
              <ul class="list">
                ${Object.entries(categoryCounts).map(([item, v]) =>
                  `<li>${item}：已处理 ${v.processed || 0} / 未处理 ${v.pending || 0}</li>`
                ).join('')}
              </ul>
            </div>
          `;

          if (loading) loading.style.display = 'none';
          if (table) table.style.display = 'table';
        } catch (err) {
          window.__showErr(err?.message || err);
        }
      });
    } catch (e) {
      window.__showErr('初始化失败：' + (e?.message || e));
    }
  })();
  </script>
</body>
</html>
